#!/bin/sh

set -eu

command -v git >/dev/null || exit 1
toplevel="$(git rev-parse --show-toplevel)"
target="${toplevel}/usr/share/usability-misc/dist-installer-cli-standalone"
template="${toplevel}/usr/bin/dist-installer-cli"
helper_path="/usr/libexec/helper-scripts/"

cp "${template}" "${target}"
awk -v origin="${0##*/}" -v helper="source ${helper_path}" '
  $0 ~ helper {
    print "##### BEGIN pasted by "origin " from file "$2
    system("cat "$2)
    print "##### END pasted by "origin " from file "$2
    next
  }
  1
' "${template}" | tee "${target}" >/dev/null
sed -i \
  -e "\,^\s*source /usr/libexec/helper-scripts/,d" \
  -e "3i ## DO NOT MODIFY, AUTOGENERATED CODE, MODIFY ../../bin/dist-installer-cli and the functions sourced" \
  "${target}"
